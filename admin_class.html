
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Class Assignment | CMCS VLS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #050505; color: white; overflow: hidden; }
        .logo-watermark { position: fixed; inset: 0; z-index: -1; display: flex; justify-content: center; align-items: center; opacity: 0.06; pointer-events: none; }
        .logo-watermark img { height: 80%; max-width: none; object-fit: contain; filter: grayscale(1) brightness(0.5); }
        .glass-card { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 1.5rem; }
        .nav-link { transition: all 0.3s ease; border: 1px solid transparent; }
        .nav-link:hover { background: rgba(255, 255, 255, 0.05); border-color: rgba(255, 255, 255, 0.1); }
        .nav-link.active { background: white; color: black !important; }
        .sidebar { background: rgba(0, 0, 0, 0.3); backdrop-filter: blur(20px); border-right: 1px solid rgba(255, 255, 255, 0.05); }
        /* Universal Dark Dropdown Styling */
        select {
            appearance: none; /* Removes default browser styling */
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='rgba(255,255,255,0.5)'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 1em;
            padding-right: 2.5rem;
        }
        
        /* This targets the actual dropdown menu items */
        select option {
            background-color: #1a1a1a !important; /* Deep charcoal background */
            color: white !important;               /* Pure white text */
            padding: 10px;
        }
        
        /* Removes the white background on focus for some browsers */
        select:focus {
            background-color: rgba(255, 255, 255, 0.1) !important;
        }
        /* Input Styling */
        input, select { 
            background: rgba(255, 255, 255, 0.05) !important; 
            border: 1px solid rgba(255, 255, 255, 0.1) !important; 
            color: white !important;
            transition: all 0.2s ease;
        }
        input:focus, select:focus { border-color: rgba(255, 255, 255, 0.4) !important; outline: none; }
        ::placeholder { color: rgba(255, 255, 255, 0.2); }

        .loader { border: 2px solid rgba(255,255,255,0.1); border-top: 2px solid #fff; border-radius: 50%; width: 14px; height: 14px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }
    </style>
</head>
<body class="h-screen flex">

    <div class="logo-watermark">
        <img src="https://sklepagatesting.github.io/resources/Images/CMCSlogo.png" alt="CMCS Logo">
    </div>

 <aside class="w-72 sidebar flex flex-col z-20">
        <div class="h-20 flex items-center px-8 border-b border-white/5">
            <div class="flex items-center gap-3">
                <img src="https://sklepagatesting.github.io/resources/Images/CMCSlogo.png" class="h-8 brightness-125">
                <span class="font-black text-lg tracking-tighter uppercase">CMCS <span class="text-gray-500">VLS</span></span>
            </div>
        </div>

        <nav class="flex-1 py-8 px-4 space-y-2 overflow-y-auto">
            <p class="px-4 text-[10px] font-bold text-gray-500 uppercase tracking-[0.3em] mb-4">Main Menu</p>
            <a href="admin_dashboard.html" class="nav-link flex items-center gap-4 px-4 py-3.5 rounded-2xl text-sm font-semibold text-gray-400">
                <i class="fa-solid fa-chart-line text-base"></i> Dashboard
            </a>
            <a href="admin_approval.html" class="nav-link flex items-center gap-4 px-4 py-3.5 rounded-2xl text-sm font-semibold text-gray-400">
                <i class="fa-solid fa-check-to-slot text-base"></i> Approvals
            </a>
            <a href="admin_setup.html" class="nav-link flex items-center gap-4 px-4 py-3.5 rounded-2xl text-sm font-semibold text-gray-400">
                <i class="fa-solid fa-school text-base"></i> Academic Setup
            </a>
            <a href="admin_class.html" class="nav-link active flex items-center gap-4 px-4 py-3.5 rounded-2xl text-sm font-semibold">
                <i class="fa-solid fa-chalkboard-user text-base"></i> Class Assignment
            </a>
            <a href="admin_records.html" class="nav-link flex items-center gap-4 px-4 py-3.5 rounded-2xl text-sm font-semibold text-gray-400">
                <i class="fa-solid fa-folder-open text-base"></i> Master Record
            </a>
            <a href="admin_accounts.html" class="nav-link flex items-center gap-4 px-4 py-3.5 rounded-2xl text-sm font-semibold text-gray-400">
                <i class="fa-solid fa-users-gear text-base"></i> Accounts
            </a>
        </nav>

        <div class="p-6 border-t border-white/5">
            <a href="admin_edit.html" class="glass-card p-4 flex items-center gap-3 mb-4 block hover:border-white/20 transition-all">
                <div id="adminInitial" class="w-10 h-10 rounded-full bg-white flex items-center justify-center text-xs font-bold text-black uppercase">AD</div>
                <div class="flex-1 min-w-0">
                    <p class="text-xs font-bold truncate uppercase text-white" id="adminName">Loading...</p>
                    <p class="text-[9px] text-gray-500 font-bold uppercase tracking-widest">Administrator</p>
                </div>
            </a>
            <button onclick="logout()" class="w-full py-3 rounded-xl bg-red-500/10 text-red-500 text-[10px] font-black uppercase tracking-[0.2em] hover:bg-red-500 hover:text-white transition-all">
                Sign Out
            </button>
        </div>
    </aside>

    <main class="flex-1 flex flex-col overflow-hidden">
        <header class="h-20 flex items-center justify-between px-10 border-b border-white/5">
            <h1 class="text-sm font-bold uppercase tracking-[0.2em] text-gray-400">Enrollment <span class="text-white">Manager</span></h1>
            <div class="flex items-center gap-6">
                <div class="text-right">
                    <p id="clock" class="text-sm font-black tracking-widest text-white">--:--</p>
                    <p id="currentDate" class="text-[10px] font-bold text-gray-500 uppercase">--- --, ----</p>
                </div>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto p-10 space-y-8">
            <div class="glass-card p-8">
                <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 items-end">
                    <div>
                        <label class="block text-[9px] font-black text-gray-500 uppercase mb-3 tracking-[0.2em]">Target Course</label>
                        <select id="filterCourse" class="w-full rounded-xl px-4 py-3 text-xs font-bold uppercase"></select>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-[9px] font-black text-gray-500 uppercase mb-3 tracking-[0.2em]">Year</label>
                            <select id="filterYear" class="w-full rounded-xl px-4 py-3 text-xs font-bold uppercase">
                                <option value="1">1ST YEAR</option>
                                <option value="2">2ND YEAR</option>
                                <option value="3">3RD YEAR</option>
                                <option value="4">4TH YEAR</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-[9px] font-black text-gray-500 uppercase mb-3 tracking-[0.2em]">Semester</label>
                            <select id="filterSem" class="w-full rounded-xl px-4 py-3 text-xs font-bold uppercase">
                                <option value="1ST SEMESTER">1ST SEM</option>
                                <option value="2ND SEMESTER">2ND SEM</option>
                                <option value="SUMMER">SUMMER</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="block text-[9px] font-black text-gray-500 uppercase mb-3 tracking-[0.2em]">Quick Search</label>
                        <div class="relative">
                            <i class="fa-solid fa-magnifying-glass absolute left-4 top-1/2 -translate-y-1/2 text-gray-500 text-xs"></i>
                            <input type="text" id="searchField" class="w-full pl-10 pr-4 py-3 rounded-xl text-xs font-bold uppercase" placeholder="SEARCH DIRECTORY...">
                        </div>
                    </div>
                    <button id="fetchBtn" class="bg-white text-black h-[46px] rounded-xl text-[10px] font-black uppercase tracking-widest hover:scale-[1.02] active:scale-[0.98] transition-all flex items-center justify-center gap-2">
                        <i class="fa-solid fa-sync-alt"></i> Fetch Data
                    </button>
                </div>
            </div>

            <div class="glass-card overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead>
                            <tr class="text-[10px] font-black text-gray-500 uppercase tracking-widest border-b border-white/5">
                                <th class="px-8 py-5" width="80">Rank</th>
                                <th class="px-8 py-5">Student Identity</th>
                                <th class="px-8 py-5">Academic Level</th>
                                <th class="px-8 py-5">Assigned Loads</th>
                                <th class="px-8 py-5 text-right">Operation</th>
                            </tr>
                        </thead>
                        <tbody id="studentTableBody" class="divide-y divide-white/5 text-sm">
                            <tr><td colspan="5" class="px-8 py-20 text-center text-gray-500 uppercase text-[10px] font-bold tracking-[0.3em]">Configure filters to load records</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <div id="classModal" class="fixed inset-0 bg-black/80 backdrop-blur-md hidden items-center justify-center z-50 p-4">
        <div class="glass-card w-full max-w-xl border-white/20 overflow-hidden flex flex-col max-h-[90vh]">
            <div class="px-8 py-6 border-b border-white/5 flex justify-between items-center bg-white/[0.02]">
                <div class="flex items-center gap-3">
                    <span class="font-black text-white text-[10px] uppercase tracking-[0.2em]">Enrollment Load Manager</span>
                </div>
                <button onclick="closeModal('classModal')" class="text-gray-500 hover:text-white transition-all"><i class="fa-solid fa-times"></i></button>
            </div>
            
            <div class="p-8 overflow-y-auto">
                <div class="mb-8 p-6 bg-white/[0.03] rounded-2xl border border-white/10">
                    <p class="text-[9px] font-black text-gray-500 uppercase mb-2 tracking-widest">Enrollment Target</p>
                    <p id="targetStudentName" class="text-xl font-black text-white uppercase tracking-tighter"></p>
                    <div id="targetStudentSubInfo" class="text-[10px] text-gray-400 font-bold mt-2 uppercase tracking-widest"></div>
                </div>

                <div class="space-y-2">
                    <div class="grid grid-cols-[50px_1fr] gap-4 px-4 py-2 text-[9px] font-black text-gray-500 uppercase tracking-widest mb-2">
                        <span class="text-center">Set</span>
                        <span>Subject & Schedule Details</span>
                    </div>
                    <div id="programList" class="space-y-3"></div>
                </div>
            </div>

            <div class="p-8 border-t border-white/5 flex justify-end gap-4 bg-white/[0.02]">
                <button id="saveClassesBtn" class="w-full bg-white text-black py-4 rounded-full font-black text-[10px] uppercase tracking-widest hover:opacity-90 active:scale-[0.98] transition-all flex items-center justify-center gap-2">
                    <i class="fa-solid fa-check-circle"></i> Commit Load Update
                </button>
            </div>
        </div>
    </div>

    <div id="notifModal" class="fixed inset-0 bg-black/80 backdrop-blur-md hidden items-center justify-center z-[100] p-4">
        <div class="glass-card max-w-sm w-full p-8 text-center border-white/20">
            <h3 class="text-sm font-black text-white uppercase tracking-widest mb-4">System Message</h3>
            <p id="notifMessage" class="text-sm text-gray-400 mb-8 leading-relaxed"></p>
            <button onclick="closeModal('notifModal')" class="w-full bg-white text-black py-4 rounded-full font-black text-[10px] uppercase tracking-widest">Dismiss</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, query, where, getDocs, doc, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = { 
            apiKey: "AIzaSyDaeNQF4qmW0vvwxUPp_NztnT0hoLzm1BQ",
            authDomain: "svls-289ee.firebaseapp.com",
            projectId: "svls-289ee",
            storageBucket: "svls-289ee.firebasestorage.app",
            messagingSenderId: "500705386198",
            appId: "1:500705386198:web:96f189662bc2aa99cf7377"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let currentStudentUid = null;
        let fetchedStudents = [];

        window.showNotif = (msg) => {
            document.getElementById('notifMessage').innerText = msg;
            document.getElementById('notifModal').style.display = 'flex';
        };

        window.closeModal = (id) => { document.getElementById(id).style.display = 'none'; };

        onAuthStateChanged(auth, async user => {
            if (user) {
                const snap = await getDoc(doc(db, "users", user.uid));
                if (snap.exists() && snap.data().role === 'admin') {
                    const data = snap.data();
                    document.getElementById('adminName').innerText = `${data.lastname}, ${data.firstname}`.toUpperCase();
                    document.getElementById('adminInitial').innerText = data.firstname.charAt(0).toUpperCase();
                    await loadCourses();
                } else {
                    window.location.href = "login.html";
                }
            } else { window.location.href = "login.html"; }
        });

        async function loadCourses() {
            const snap = await getDocs(collection(db, "courses"));
            const sel = document.getElementById('filterCourse');
            let options = '<option value="" disabled selected>SELECT COURSE</option>';
            snap.forEach(d => {
                const name = d.data().name.toUpperCase();
                options += `<option value="${name}">${name}</option>`;
            });
            sel.innerHTML = options;
        }

        function renderTable(students) {
            const tbody = document.getElementById('studentTableBody');
            if (students.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="px-8 py-20 text-center text-red-500 font-black uppercase tracking-widest text-[10px]">No records match selected criteria</td></tr>';
                return;
            }

            tbody.innerHTML = students.map((s, idx) => {
                const subjects = s.assignedPrograms && s.assignedPrograms.length > 0 
                    ? s.assignedPrograms.map(p => `<span class="inline-block bg-white/5 border border-white/10 text-[9px] px-2 py-1 rounded-md font-black text-gray-300 mr-1 mb-1 uppercase">${p}</span>`).join('') 
                    : '<span class="text-gray-600 text-[9px] font-black uppercase italic tracking-widest">Awaiting Load</span>';

                return `
                    <tr class="hover:bg-white/[0.02] transition-colors">
                        <td class="px-8 py-6 text-gray-600 font-black text-[10px]">${idx + 1}</td>
                        <td class="px-8 py-6">
                            <div class="font-black text-white uppercase tracking-tighter">${s.lastname}, ${s.firstname}</div>
                            <div class="text-[9px] font-bold text-gray-500 tracking-widest mt-0.5">${s.studentId || 'NO ID'}</div>
                        </td>
                        <td class="px-8 py-6">
                            <div class="text-[10px] font-black text-white uppercase">${s.course}</div>
                            <div class="text-[9px] font-black text-gray-500 uppercase tracking-widest mt-0.5">Y${s.year} • ${s.semester}</div>
                        </td>
                        <td class="px-8 py-6"><div class="flex flex-wrap max-w-sm">${subjects}</div></td>
                        <td class="px-8 py-6 text-right">
                            <button onclick="openClassModal('${s.uid}', '${s.lastname}, ${s.firstname}')" class="px-4 py-2 rounded-xl bg-white/5 border border-white/10 text-[9px] font-black text-white uppercase tracking-widest hover:bg-white hover:text-black transition-all">
                                Update
                            </button>
                        </td>
                    </tr>`;
            }).join('');
        }

        document.getElementById('searchField').oninput = (e) => {
            const q = e.target.value.toUpperCase();
            const filtered = fetchedStudents.filter(s => 
                s.lastname.toUpperCase().includes(q) || s.firstname.toUpperCase().includes(q) || (s.studentId && s.studentId.toUpperCase().includes(q))
            );
            renderTable(filtered);
        };

        window.openClassModal = async (uid, name) => {
            currentStudentUid = uid;
            const course = document.getElementById('filterCourse').value;
            const year = document.getElementById('filterYear').value;
            const sem = document.getElementById('filterSem').value;

            document.getElementById('targetStudentName').innerText = name.toUpperCase();
            document.getElementById('targetStudentSubInfo').innerText = `${course} • YEAR ${year} • ${sem}`;
            
            const listDiv = document.getElementById('programList');
            listDiv.innerHTML = '<div class="p-10 text-center"><span class="loader"></span></div>';
            document.getElementById('classModal').style.display = 'flex';

            try {
                const q = query(collection(db, "programs"), where("course", "==", course), where("year", "==", year), where("semester", "==", sem));
                const [progSnap, userSnap] = await Promise.all([getDocs(q), getDoc(doc(db, "users", uid))]);
                const enrolled = userSnap.data().assignedPrograms || [];

                if(progSnap.empty) {
                    listDiv.innerHTML = '<div class="p-10 text-center text-gray-500 text-[10px] font-black uppercase tracking-widest">No subjects defined for this level.</div>';
                    return;
                }

                listDiv.innerHTML = progSnap.docs.map(p => {
                    const d = p.data();
                    const code = d.code.toUpperCase();
                    const isInactive = (d.status === "INACTIVE");
                    const checked = enrolled.includes(code) ? 'checked' : '';
                    
                    return `
                        <label class="group flex items-center gap-6 p-4 rounded-2xl bg-white/[0.03] border border-white/5 hover:border-white/20 transition-all cursor-pointer ${isInactive ? 'opacity-50' : ''}">
                            <div class="flex items-center justify-center w-6">
                                <input type="checkbox" value="${code}" ${checked} class="prog-checkbox w-4 h-4 rounded border-white/10 bg-transparent text-white focus:ring-offset-black">
                            </div>
                            <div class="flex-1">
                                <div class="flex justify-between items-center mb-1">
                                    <span class="text-[10px] font-black text-white tracking-widest">${code}</span>
                                    ${isInactive ? '<span class="text-[8px] font-black text-red-500 uppercase">Inactive</span>' : ''}
                                </div>
                                <div class="text-xs font-bold text-gray-400 uppercase tracking-tighter">${d.name}</div>
                                <div class="text-[9px] font-black text-gray-600 uppercase mt-1 tracking-widest">${d.schedule || 'TBA'}</div>
                            </div>
                        </label>`;
                }).join('');
            } catch (err) { listDiv.innerHTML = '<div class="p-10 text-center text-red-500 text-[10px] font-black">SYNC ERROR</div>'; }
        };

        document.getElementById('fetchBtn').onclick = async () => {
            const course = document.getElementById('filterCourse').value;
            const year = document.getElementById('filterYear').value;
            const sem = document.getElementById('filterSem').value;
            const btn = document.getElementById('fetchBtn');
            const tbody = document.getElementById('studentTableBody');
            
            if(!course) { showNotif("Select a course program."); return; }
            
            btn.innerHTML = '<span class="loader"></span> FETCHING';
            tbody.innerHTML = '<tr><td colspan="5" class="px-8 py-20 text-center"><span class="loader"></span></td></tr>';

            try {
                const q = query(collection(db, "users"), where("role", "==", "student"), where("status", "==", "approved"), where("course", "==", course), where("year", "==", year), where("semester", "==", sem));
                const snap = await getDocs(q);
                fetchedStudents = snap.docs.map(u => ({ uid: u.id, ...u.data() }));
                renderTable(fetchedStudents);
                document.getElementById('searchField').value = '';
            } catch (e) { showNotif("Access error."); } 
            finally { btn.innerHTML = '<i class="fa-solid fa-sync-alt"></i> Fetch Data'; }
        };

        document.getElementById('saveClassesBtn').onclick = async () => {
            const selected = Array.from(document.querySelectorAll('.prog-checkbox:checked')).map(cb => cb.value);
            const btn = document.getElementById('saveClassesBtn');
            btn.disabled = true;
            btn.innerHTML = 'SYNCING LOAD...';

            try {
                await updateDoc(doc(db, "users", currentStudentUid), { assignedPrograms: selected });
                closeModal('classModal');
                showNotif("Enrollment Load Updated.");
                document.getElementById('fetchBtn').click();
            } catch (err) { showNotif("Update failed."); }
            finally { btn.disabled = false; btn.innerHTML = '<i class="fa-solid fa-check-circle"></i> Commit Load Update'; }
        };

        window.logout = () => signOut(auth).then(() => window.location.href = "login.html");
        setInterval(() => {
            const clock = document.getElementById('clock');
            if(clock) clock.innerText = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', second:'2-digit', hour12: false});
        }, 1000);

        const updateDate = () => {
    const el = document.getElementById('currentDate');
    if (el) {
        el.innerText = new Date().toLocaleDateString(undefined, { 
            month: 'short', 
            day: 'numeric', 
            year: 'numeric' 
        });
    }
};

// Run immediately on load
updateDate();

// Optional: Refresh every hour just to be safe for day-changes
setInterval(updateDate, 3600000);
    </script>
</body>
</html>
